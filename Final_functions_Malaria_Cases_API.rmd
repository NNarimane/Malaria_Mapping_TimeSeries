---
title: "Malaria_Cases_API_final_functions"
author: "Raquel Lana, Narimane Nekkab, Daniel Villela"
date: "4 de fevereiro de 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Final functions for the analyzes and figures of the first paper

- Packages - move to header file together the parameters.
```{r}
library("ggplot2")
library("forecast")
library("tseries")
library("stringr")
library("gridExtra")
library("data.table")
library("fUnitRoots")
library("FitAR")
library("lubridate")
#library("parallel")
library("TSA")
library("dplyr")
library("foreach")
library("tstools")
library("ggfortify")
library("RColorBrewer")
library("colorspace")
library("foreign")
library("tidyverse")
library("maptools")
library("rgdal")
#devtools::install_github("hrbrmstr/streamgraph") 
library("streamgraph")
library(webshot)
#install phantom:
webshot::install_phantomjs()

```

- mover para o header file para rodar a função abaixo
```{r}
# Get SIVEP data cleaned up and by species
#SIVEPFilePath = "~/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData"
envNN = F

if(envNN){
  SIVEPFilePath = "./API_Noti_weeklyAPI_state.Rdata" # Daniel
} else{SIVEPFilePath = "/home/rlana/Dados/API_Noti_weeklyAPI_state.Rdata"} # Raquel

#SIVEPFilePath = "/home/rlana/Dados/SIVEP_clean_2003_2018.RData"
#SIVEPFilePath = "/home/daniel/temp/Malaria_mapping"
StartYear = 2004 # (inferior limit = 2003)
EndYear = 2018 # (superior limit = 2018)
AgTimeUnit = "week" # ("week", "month")
byNotification = T 
byResidence = F
byInfection = F
byPCD = F
byPCDACD = T

```

### Function to organize the SIVEP database per:
- DATE: from the date of notification being that it can provide the first day of the epidemiological week in which the notification date was made or the month of this date.    
- LEVEL: Country (BR), State (UF), Municipality (MU).   
- CODE: Country (1), State (Amazon Basin states IBGE codes) and Municipality (Amazon Basin municipalities IBGE codes).  
- TYPE: Falciparum ou Vivax malaria
- Cases: number of cases counted by date, level, code and type of malaria.  
```{r}
getWEEKLY_SIVEP_MALARIA_TYPE <- function(SIVEPFilePath, StartYear, EndYear, AgTimeUnit){
  
  # Get SIVEP raw notification data
  load(SIVEPFilePath)

  # Choose time period
  df <- df[which(df[,"DT_NOTIF"] >= paste0(StartYear,"-01-01") & df[,"DT_NOTIF"] <= paste0(EndYear, "-12-31")),] # parece não funcionar para residencia e prob infe, mas na sequencia corta...quando vai para merge com população
  
  
  # Replace missing state code with municipality state code
  df <- df %>% 
    mutate(UF_NOTIF = as.integer(substr(as.character(MUN_NOTI), 1, 2)),
           UF_RESID = as.integer(substr(as.character(MUN_RESI), 1, 2)),
           UF_INFEC = as.integer(substr(as.character(MUN_INFE), 1, 2)))
  
  # Select administrative level via code
  if(byNotification){
    df$PAIS_CODE <- 1
    names(df)[names(df) == 'UF_NOTIF'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_NOTI'] <- 'MUN_CODE'
  }
  if(byResidence){
    names(df)[names(df) == 'PAIS_RES'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_RESID'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_RESI'] <- 'MUN_CODE'
  }
  if(byInfection){
    names(df)[names(df) == 'PAIS_INF'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_INFEC'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_INFE'] <- 'MUN_CODE'
  }
  
  #Select the cases by Type of Detection
  if(byPCD){
    df <- df %>%
      filter(TIPO_LAM == "PCD")
  }

  if(byPCDACD){
    df <- df %>%
      filter(TIPO_LAM == "PCD" | TIPO_LAM == "ACD")
  }
  
  # Split data by malaria type and aggregate to MU - level
  week_malaria_type_muni <- df %>%
    group_by(DT_NOTIF, MUN_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "MU") %>%
    select(DT_NOTIF, LEVEL, MUN_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = MUN_CODE,
           FALCI = "F",
           VF = "V+F",
           VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE))

  
  # UF - level
  week_malaria_type_state <- df %>%
    group_by(DT_NOTIF, UF_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "UF") %>%
    select(DT_NOTIF, LEVEL, UF_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = UF_CODE,
           FALCI = "F",
           VF = "V+F",
           VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%      
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE))
  
  # BR - level
  week_malaria_type_brazil <- df %>%
    group_by(DT_NOTIF, PAIS_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "BR")  %>% 
    select(DT_NOTIF, LEVEL, PAIS_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = PAIS_CODE,
           FALCI = "F",
           VF = "V+F",
           VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE))
    
  # Merge together
  SIVEP_MALARIA_TYPE <- rbind(week_malaria_type_brazil, week_malaria_type_state, week_malaria_type_muni)
  rm(df, week_malaria_type_brazil, week_malaria_type_state, week_malaria_type_muni)


  return(SIVEP_MALARIA_TYPE)
  
}


```

Move to header file
```{r}
d <- getWEEKLY_SIVEP_MALARIA_TYPE(SIVEPFilePath, StartYear, EndYear, AgTimeUnit)

```



### Function to agreggate the population size from IBGE and calculate API.
- Move to header file 
```{r}
#IBGEFilePath = "~/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Malaria_Mapping_TimeSeries_Data/BRA_POP_EST.csv"
#IBGEFilePath = "~/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Pasteur/Malaria_Mapping_TimeSeries_Data/BRA_POP_EST.csv"
IBGEFilePath = "/home/rlana/Dados/BRA_POP_EST.csv"
IBGEFilePath = "/home/daniel/temp/Malaria_mapping"
#StartYear = 2004 # (inferior limit = 2003)
#EndYear = 2017 # (superior limit = 2018)
#AgTimeUnit = "week" # ("week", "month")
unitTime <- ifelse(AgTimeUnit == "week", 52, 12) # If AgTimeUnit == "week", unitTime == 52

```

- NAME: name of the administrative levels.  
- YEAR: year of the notification and population estimated.  
- POP_SIZE: population estimated by year and administrative levels
- API: annual parasite index 
 
```{r}
getWEEKLY_SIVEP_API <- function(IBGEFilePath, StartYear, EndYear, AgTimeUnit){
  
  # Get IBGE population size 
  d1 <- read.csv(IBGEFilePath, stringsAsFactors = F)
  # Get names
  ADMIN_NAMES <- read.table("/home/rlana/Dados/BRA_ADMIN_NAMES.csv", sep = " ")
  #ADMIN_NAMES <- read.table("/home/daniel/temp/Malaria_mapping/BRA_ADMIN_NAMES.csv", sep = " ") 
  
  # Reshape the population size table to join with cases table
  d1 <- d1 %>%
    select(-GR) %>%
    filter(!LEVEL %in% c("GR")) %>%
    mutate(CODE = replace(CODE, CODE == 0, 1)) %>%
    gather(key = YEAR, value = POP_SIZE, -c(LEVEL, CODE, NAME)) %>%
    mutate(YEAR = as.integer(str_sub(YEAR, start = 2, end = 5))) %>%
    filter(YEAR >= StartYear & YEAR <= EndYear) 

  # Cut the database only for Amazon Basin States and municipalities
  ADMIN_NAMES <- ADMIN_NAMES %>%
    ungroup %>%
    filter(Level != "GR") %>%
    mutate(CODE = replace(Code, Code == 0, 1))

  d1$STATE = ADMIN_NAMES[match(d1$CODE, ADMIN_NAMES$Code),"UF"] 
  d1$NAME = ADMIN_NAMES[match(d1$CODE, ADMIN_NAMES$Code),"Name"]

  d1 <- d1 %>% 
    filter(STATE == "AC"| STATE == "AM" | STATE == "AP" | STATE == "MA" | STATE == "MT" | STATE == "PA" | STATE == "RO" | STATE == "RR" | STATE == "TO")

  # Add BR level again only for Amazon Basin population
  dBR <- d1 %>% 
    filter(LEVEL == "UF") %>% 
    group_by(YEAR) %>% 
    summarise(POP_SIZE = sum(POP_SIZE)) %>% 
    mutate(LEVEL = "BR",
           CODE = 1,
           NAME = "Amazonia Legal",
           STATE = "NA") %>% 
    select(CODE, LEVEL, NAME, YEAR, POP_SIZE, STATE)
  
  d1 <- bind_rows(dBR, d1)
  
  # Agregate cases by time and create the column year
  d <- d %>% 
    group_by(DATE, LEVEL, CODE, TYPE) %>% 
    summarise(CASES = sum(CASES)) %>% 
    mutate(YEAR = year(DATE))
    
  # Join cases and population tables
  API_MALARIA <- left_join(d1, d)  
  
  # Calculate API and reorder columns and rearrange variables
  API_MALARIA <- API_MALARIA %>% 
    mutate(API = CASES/POP_SIZE * 1000 * unitTime) %>%
    select(LEVEL, CODE, NAME,STATE, DATE, YEAR, TYPE, CASES, POP_SIZE, API) %>%
    arrange(DATE, YEAR, CODE)
  
  return(API_MALARIA)
  
}

```

- Move to header file 
```{r}
d2 <- getWEEKLY_SIVEP_API(IBGEFilePath, StartYear, EndYear, AgTimeUnit)

```

- Save
```{r}
save(d2, file = "/home/rlana/Dados/API_Noti_weeklyAPI_state.Rdata")
#save(d2, file = "/home/daniel/temp/Malaria_mapping")
```


# Function to calculate Pf/Pv and Pv/Total  ratios
- Check if here It's necessary to group by YEAR.
- Obs.: for some strange reason **tidyr** needs another index to do the **spread** sometimes.

Function
```{r}  
getWEEKLY_SIVEP_RATIOS <- function(API_MALARIA, StartYear, EndYear, AgTimeUnit){

  # Spreading to facilitate the ratio's calculus
  RATIOS <- d2 %>%
  select(LEVEL, CODE, NAME, DATE, YEAR, TYPE, CASES) %>%
  group_by_at(vars(-CASES)) %>%  # group by everything other than the value column. 
  mutate(row_id = 1:n()) %>%   #rowid_to_column() - ver essa função pra ver se fica igual
  ungroup() %>%  # build group index
  spread(key = TYPE, value = CASES, fill = 0) %>%    # spread
  select(-row_id) %>%  # drop the index
  mutate(PvPf = Falciparum / Vivax,
         PvTOTAL = Vivax / (Falciparum + Vivax)
         ) %>%
  select(LEVEL, CODE, NAME, DATE, YEAR, PvPf, PvTOTAL)  
  
  return(RATIOS)  
  
}

```

Move to header file
```{r}
d3 <- getWEEKLY_SIVEP_RATIOS(API_MALARIA, StartYear, EndYear, AgTimeUnit) 

```



### Cases and API Brazil time series plot 
Não consegui cortar o 2019 do gráfico.  

```{r}
#Move to header
# Date type (by day == "Daily" , week == "Weekly", month == "Monthly", year == "Yearly")
Date_Type = "Weekly"

envNN = F

if(envNN){
  Plot_Folder = "/home/daniel/temp/Malaria_mapping" # Daniel
} else{Plot_Folder = "/home/rlana/Plots/TimeSeries/BR"} # Raquel


#Cases
Cases_TS_BR <- ggplot(data = subset(d2, LEVEL == "BR"), aes(DATE, CASES, color = TYPE)) +
  stat_summary(fun.y = sum, geom = "line") +
   scale_x_date(breaks = "year",
               date_labels = "%Y",
               limits = c(min(d2$DATE), max(d2$DATE)),
               expand = c(0.01, 0)) +  #Tentei colocar limite até 2018 por aqui e não consegui
  scale_color_manual(values = c("#31a354","#3182bd")) +
  labs(title = paste0("P. vivax and P. falciparum ", "cases in Brazil, ", 
                      StartYear, "-", EndYear), x = "Year", y = paste(Date_Type,"cases")) + 
  guides(color = guide_legend(title = "Plasmodium")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="bottom",
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 6, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 6),
        axis.title = element_text(size = 5),
        axis.text = element_text(size = 5))

Cases_TS_BR

# Save
ggsave(Cases_TS_BR, filename = paste0("P. vivax and P. falciparum cases in Brazil ", StartYear, "-", EndYear, ".png"), width = 1500/300, height = 1000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")



#API
API_TS_BR <- ggplot(data = subset(d2, LEVEL == "BR"), aes(DATE, APIw, color = TYPE)) +
  stat_summary(fun.y = sum, geom = "line") +
  scale_x_date(breaks = "year",
               date_labels = "%Y",
               limits = c(min(d2$DATE), max(d2$DATE)),
               expand = c(0.01, 0)) +
  scale_color_manual(values = c("#31a354","#3182bd")) +
  labs(title = paste0("P. vivax and P. falciparum ", "API in Brazil, ", 
                      StartYear, "-", EndYear), x = "Year", y = paste(Date_Type,"API")) + 
  guides(color = guide_legend(title = "Plasmodium")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="bottom",
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 6, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 6),
        axis.title = element_text(size = 5),
        axis.text = element_text(size = 5))

API_TS_BR

# Save
ggsave(API_TS_BR, filename = paste0("P. vivax and P. falciparum API in Brazil ", StartYear, "-", EndYear, ".png"), width = 1500/300, height = 1000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")

```



# Time series by STATE- one figure with all states.  
- supp file  

```{r}
envNN = F

if(envNN){
  Plot_Folder = "/home/daniel/temp/Malaria_mapping" # Daniel
} else{Plot_Folder = "/home/rlana/Plots/TimeSeries/BR"} # Raquel


Cases_Plot_State <- ggplot(data = subset(d2, LEVEL == "UF"), aes(DATE, CASES, color = TYPE)) +
  stat_summary(fun.y = sum, geom = "line") +
  scale_x_date(breaks = "2 years",
               date_labels = "%Y",
               limits = c(min(d2$DATE), max(d2$DATE)),
               expand = c(0.01, 0)) +
  facet_wrap(.~NAME, ncol = 3) +
  scale_color_manual(values = c("#31a354","#3182bd"), label = c("falciparum", "vivax")) +
  labs(title = paste0("Malaria ", "cases in Brazil, ", 
                      StartYear, "-", EndYear), x = "Year", y = paste(Date_Type,"cases")) +
  guides(color = guide_legend(title = "Plasmodium")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom",
        legend.text = element_text(size = 12, face = "italic"),
        legend.title = element_text(size = 12, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 12),
        plot.margin = unit(c(0.1,0.3,0,0.15),"cm"), #top, right, bottom and left
        strip.text.x = element_text(size = 11)) 

Cases_Plot_State

# Save
ggsave(Cases_Plot_State, filename = paste0("Teste3_P. vivax and P. falciparum cases in Brazil per State", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")


API_Plot_State <- ggplot(data = subset(d2, LEVEL == "UF"), aes(DATE, APIw, color = TYPE)) +
  stat_summary(fun.y = sum, geom = "line") +
  scale_x_date(breaks = "2 years",
               date_labels = "%Y",
               limits = c(min(d2$DATE), max(d2$DATE)),
               expand = c(0.01, 0)) +
  facet_wrap(.~NAME, ncol = 3) +
  scale_color_manual(values = c("#31a354","#3182bd"), label = c("falciparum", "vivax")) +
  labs(title = paste0("API ", "in Brazil, ", 
                      StartYear, "-", EndYear), x = "Year", y = paste(Date_Type,"API")) +
  guides(color = guide_legend(title = "Plasmodium")) +
 theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom",
        legend.text = element_text(size = 12, face = "italic"),
        legend.title = element_text(size = 12, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 12),
        plot.margin = unit(c(0.1,0.3,0,0.15),"cm"), #top, right, bottom and left
        strip.text.x = element_text(size = 11)) 

API_Plot_State

# Save
ggsave(API_Plot_State, filename = paste0("Teste2_P. vivax and P. falciparum API in Brazil per State", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")

```


### State plots - each state separetely

- Refazer utilizando o modelo do último plot
- Aumentar os textos também usando o de cima, depois testar em A4.

```{r}
States_sivep = c("AC","AM","AP","MA","MT","PA","RO","RR","TO")
States_code = c(11, 12, 13, 14, 15, 16, 17, 21, 51)  

UF_Plots <- foreach(i = 1:length(States_sivep)) %do% {
  Plot_Name = paste0("TS_Plot_", States_sivep[i])
  assign(Plot_Name, ggplot(data = subset(d2, LEVEL == "UF" & STATE == States_sivep[i]), 
                           aes(DATE, CASES, color = TYPE)) +
           stat_summary(fun.y = sum, geom = "line") +
           scale_x_date(breaks = "year", 
                        date_labels = "%Y",
               limits = c(min(d2$DATE), max(d2$DATE)),
               expand = c(0.01, 0)) +
           scale_color_manual(values = c("#31a354","#3182bd")) +
           facet_wrap(~NAME) +
           labs(title = paste0("P. vivax and P. falciparum cases from ", 
                               StartYear, "-", EndYear), x = "Year", y = "Number of Cases") + 
           guides(color = guide_legend(title = "Plasmodium")) +
            theme(panel.grid.minor.x = element_blank(),
                  axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position="bottom",
                  legend.text = element_text(size = 7),
                  legend.title = element_text(size = 8, face = "italic"),
                  legend.margin = margin(0,0,0,0), 
                  plot.title = element_text(size = 8),
                  axis.title = element_text(size = 7),
                  axis.text = element_text(size = 7)))

ggsave(UF_Plots[[i]], filename = paste0("P. vivax and P. falciparum cases in Brazil per State", StartYear, "-", EndYear, "_", States_sivep[[i]], ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")  
  
}




UF_PlotsAPI <- foreach(i = 1:length(States_sivep)) %do% {
  Plot_Name = paste0("TS_Plot_API", States_sivep[i])
  assign(Plot_Name, ggplot(data = subset(d2, LEVEL == "UF" & STATE == States_sivep[i]), 
                           aes(DATE, APIw, color = TYPE)) +
           stat_summary(fun.y = sum, geom = "line") +
           scale_x_date(breaks = "year", 
                        date_labels = "%Y",
                        limits = c(min(d2$DATE), max(d2$DATE)),
                        expand = c(0.01, 0)) +
           scale_color_manual(values = c("#31a354","#3182bd")) +
           facet_wrap(~NAME) +
           labs(title = paste0("P. vivax and P. falciparum API from ", 
                               StartYear, "-", EndYear), x = "Year", y = "API") + 
           guides(color = guide_legend(title = "Plasmodium")) +
            theme(panel.grid.minor.x = element_blank(),
                  axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position="bottom",
                  legend.text = element_text(size = 7),
                  legend.title = element_text(size = 8, face = "italic"),
                  legend.margin = margin(0,0,0,0), 
                  plot.title = element_text(size = 8),
                  axis.title = element_text(size = 7),
                  axis.text = element_text(size = 7))
         
  )

ggsave(UF_PlotsAPI[[i]], filename = paste0("P. vivax and P. falciparum API in Brazil per State", StartYear, "-", EndYear, "_", States_sivep[[i]], ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")  
         
}


```

### Municipalities plots for each state

- Refazer utilizando o modelo do último plot

```{r}
# States
States_sivep = c("AC","AM","AP","MA","MT","PA","RO","RR","TO")

MUN_Plots <- foreach(i = 1:length(States_sivep)) %do% {
  Plot_Name = paste0("TS_Plot_", States_sivep[i])
  assign(Plot_Name, ggplot(data = subset(dAB, LEVEL == "MU" & 
                                           STATE == States_sivep[i]), 
                           aes(DATE, CASES, color = TYPE)) +
           stat_summary(fun.y = sum, geom = "line") +
           scale_x_date(breaks = "year", 
                        date_labels = "%Y") +
           scale_color_manual(values = c("#31a354","#3182bd")) +
           facet_wrap(~NAME) +
           labs(title = paste0("P. vivax and P. falciparum cases in ", States_sivep[i]," state by municipality, ", 
                               StartYear, "-", EndYear), x = "Year", y = "Number of Cases") + 
           guides(color = guide_legend(title = "Plasmodium species")) +
           theme(panel.grid.minor.x = element_blank(),
                 axis.text.x = element_text(angle = 90, hjust = 1)))
  
  

}

MUN_Plots[1]


```

## Function to organize the cases per age and gender - doing
- um painel com todos os estados- somatório de todos os anos.
- Para suplementar, seria interessante ter uma figura para cada estado mostrando por ano- facet_wrap por ano.

- Não gerei outro banco para essa parte. Não creio que precisa acrescentar aqui todas as semanas como feito no banco acima. VER DIREITO.  
- Se for usar somente idade, não precisa retirar os NAs de gender.  

```{r}

getSTRAT_AGE_GENDER <- function(SIVEPFilePath, StartYear, EndYear, AgTimeUnit){

  # Get SIVEP raw notification data
  load(SIVEPFilePath)

  # Choose time period
  df <- df[which(df[,"DT_NOTIF"] >= paste0(StartYear,"-01-01") & df[,"DT_NOTIF"] <= paste0(EndYear, "-12-31")),] # Usando essa função, restam alguns registros como ano de 2003 pois ao usar a função year do lubridate para extrair o ano pela data de notificação, tem semana epi de 2003.
  
  
  # Replace missing state code with municipality state code
  df <- df %>% 
    mutate(UF_NOTIF = as.integer(substr(as.character(MUN_NOTI), 1, 2)),
           UF_RESID = as.integer(substr(as.character(MUN_RESI), 1, 2)),
           UF_INFEC = as.integer(substr(as.character(MUN_INFE), 1, 2)))
  
  # Select administrative level via code
  if(byNotification){
    df$PAIS_CODE <- 1
    names(df)[names(df) == 'UF_NOTIF'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_NOTI'] <- 'MUN_CODE'
  }
  if(byResidence){
    names(df)[names(df) == 'PAIS_RES'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_RESID'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_RESI'] <- 'MUN_CODE'
  }
  if(byInfection){
    names(df)[names(df) == 'PAIS_INF'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_INFEC'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_INFE'] <- 'MUN_CODE'
  }
  
  #Select the cases by Type of Detection
  if(byPCD){
    df <- df %>%
      filter(TIPO_LAM == "PCD")
  }

  if(byPCDACD){
    df <- df %>%
      filter(TIPO_LAM == "PCD" | TIPO_LAM == "ACD")
  }
  
  
  # Brazil 
  day_malaria_type_brazil_age_gender <- df %>%
    group_by(DT_NOTIF, PAIS_CODE, AGE_CAT, SEXO) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "BR") %>%
    select(DT_NOTIF, LEVEL, PAIS_CODE, RES_EXAM, AGE_CAT, SEXO, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(GENDER = SEXO,
           CODE = PAIS_CODE,
           FALCI = "F",
           VF = "V+F",
           VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    mutate(GENDER = as.factor(case_when(GENDER == "F" ~ "Female",
                                        GENDER == "M" ~ "Male",
                                        TRUE ~ "NA"))) %>% 
    select(DATE, LEVEL, CODE, AGE_CAT, GENDER, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE, AGE_CAT, GENDER))
  
  # State
  day_malaria_type_state_age_gender <- df %>%
    group_by(DT_NOTIF, UF_CODE, AGE_CAT, SEXO) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "UF") %>%
    select(DT_NOTIF, LEVEL, UF_CODE, RES_EXAM, AGE_CAT, SEXO, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(GENDER = SEXO,
           CODE = UF_CODE,
           FALCI = "F",
           VF = "V+F",
           VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)  
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    mutate(GENDER = as.factor(case_when(GENDER == "F" ~ "Female",
                                        GENDER == "M" ~ "Male",
                                        TRUE ~ "NA"))) %>%   
    select(DATE, LEVEL, CODE, AGE_CAT, GENDER, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE, AGE_CAT, GENDER))
  
  # Municipality
  day_malaria_type_age_gender <- df %>%
   group_by(DT_NOTIF, MUN_CODE, AGE_CAT, SEXO) %>%
   count(RES_EXAM) %>%
   mutate(LEVEL = "MU") %>%
   select(DT_NOTIF, LEVEL, MUN_CODE, RES_EXAM, AGE_CAT, SEXO, n) %>%
   spread(RES_EXAM, n, fill = 0) %>%
   rename(GENDER = SEXO,
          CODE = MUN_CODE,
          FALCI = "F",
          VF = "V+F",
          VIVAX = "V") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    mutate(GENDER = as.factor(case_when(GENDER == "F" ~ "Female",
                                        GENDER == "M" ~ "Male",
                                        TRUE ~ "NA"))) %>% 
    select(DATE, LEVEL, CODE, AGE_CAT, GENDER, Falciparum, Vivax) %>%
    gather(key = TYPE, value = CASES, -c(DATE, LEVEL, CODE, AGE_CAT, GENDER))
  
                             
  sivep_strat <- rbind(day_malaria_type_brazil_age_gender, day_malaria_type_state_age_gender, day_malaria_type_age_gender)
  
  return(sivep_strat)

}

```

```{r}
d4 <- getSTRAT_AGE_GENDER(SIVEPFilePath, StartYear, EndYear, AgTimeUnit)

```

- join with names
```{r}
envNN = F

if(envNN){
  load("./Age_gender_Noti_weekly.Rdata") # Daniel
} else{load("/home/rlana/Dados/Age_gender_Noti_weekly.Rdata")} # Raquel



 # Get names
  ADMIN_NAMES <- read.table("/home/rlana/Dados/BRA_ADMIN_NAMES.csv", sep = " ")
  #ADMIN_NAMES <- read.table("/home/daniel/temp/Malaria_mapping/BRA_ADMIN_NAMES.csv", sep = " ")

  # Cut the database only for Amazon Basin States and municipalities
  ADMIN_NAMES <- ADMIN_NAMES %>%
    ungroup %>%
    filter(Level != "GR") %>%
    mutate(CODE = replace(Code, Code == 0, 1))

  Sivep_strat$STATE = ADMIN_NAMES[match(Sivep_strat$CODE, ADMIN_NAMES$Code),"UF"] 
  Sivep_strat$NAME = ADMIN_NAMES[match(Sivep_strat$CODE, ADMIN_NAMES$Code),"Name"]

  Sivep_strat <- Sivep_strat %>% 
    filter(STATE == "AC"| STATE == "AM" | STATE == "AP" | STATE == "MA" | STATE == "MT" | STATE == "PA" | STATE == "RO" | STATE == "RR" | STATE == "TO")

  # Add BR level again only for Amazon Basin population
  adbr <- Sivep_strat %>% 
    filter(LEVEL == "UF") %>% 
    group_by(DATE, AGE_CAT, GENDER, YEAR, TYPE) %>% 
    summarise(CASES = sum(CASES)) %>% 
    mutate(LEVEL = "BR",
           CODE = 1,
           NAME = "Amazonia Legal",
           STATE = "NA") %>% 
    select(DATE, LEVEL, CODE, AGE_CAT, GENDER, TYPE, CASES, YEAR, STATE, NAME)
  
Sivep_strat <- bind_rows(adbr, Sivep_strat)  


save(Sivep_strat , file = "/home/rlana/Dados/Age_gender_Noti_weekly.Rdata")

```  
  
# Age and gender

- Importando o banco
```{r}  
envNN = F

if(envNN){
  load("./Age_gender_Noti_weekly.Rdata") # Daniel
} else{load("/home/rlana/Dados/Age_gender_Noti_weekly.Rdata")} # Raquel

```


- Removendo NA de gender se for usar idade e sexo
```{r}
Sivep_strat <- Sivep_strat %>% 
  drop_na(GENDER)

```

### Plot age and gender per state
```{r}  
Plot_Folder = "/home/rlana/Plots/Age_Gender/BR"

Age_Gender_Plot_State <- ggplot(data = subset(Sivep_strat, LEVEL == "UF" & TYPE == "Falciparum"), aes(x = AGE_CAT, y = CASES, fill = GENDER)) + 
  stat_summary(fun.y = sum, geom = "bar", position = "dodge") +  #está somando de todos os anos? Testar.
  facet_wrap(.~NAME, ncol = 3) +
  scale_fill_manual(values = c("#31a354","#3182bd")) + 
  labs(title = paste0("P. falciparum cases stratified by age and gender, ", 
                      StartYear, "-", EndYear), x = "Age profile", y = "Cases") +
  guides(color = guide_legend(title = "Plasmodium")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, size = 11),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 12),
        axis.title = element_text(size = 12),
        plot.margin = unit(c(0.1,0.3,0,0.15),"cm"), #top, right, bottom and left
        strip.text.x = element_text(size = 11)) 

Age_Gender_Plot_State

  # theme(panel.grid.minor.x = element_blank(),
  #       axis.text.x = element_text(angle = 90, hjust = 1),
  #       legend.position="bottom",
  #       legend.text = element_text(size = 7),
  #       legend.title = element_text(size = 8, face = "italic"),
  #       legend.margin = margin(0,0,0,0), 
  #       plot.title = element_text(size = 8),
  #       axis.title = element_text(size = 7),
  #       axis.text = element_text(size = 7))
  

# Save
ggsave(Age_Gender_Plot_State, filename = paste0("Teste_P. falciparum cases in Brazil per State", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png")

```


### Plot age and gender per state per year - refazer usando o modelo do último plot

```{r}  
#Removendo NA de gender
Sivep_strat <- Sivep_strat %>% 
  drop_na(GENDER)

Plot_Folder = "/home/rlana/Plots/Age_Gender/State"
States_sivep = c("AC","AM","AP","MA","MT","PA","RO","RR","TO")

Age_Gender_Plot_State_Year <- foreach(i = 1:length(States_sivep)) %do% {
  Plot_Name = paste0("AG_Plot_", States_sivep[i])
  assign(Plot_Name, ggplot(data = subset(Sivep_strat, LEVEL == "UF" & STATE == States_sivep[i] & TYPE == "Vivax"), 
                           aes(x = AGE_CAT, y = CASES, fill = GENDER))) +
           stat_summary(fun.y = sum, geom = "bar", position = "dodge") +
           scale_fill_manual(values = c("#31a354","#3182bd")) +
           facet_wrap(.~YEAR, ncol = 3) +
           labs(title = paste0("P. vivax cases stratified by age and gender in ", States_sivep[i], " ",  
                               StartYear, "-", EndYear), x = "Age categories", y = "Number of Cases") +  
           guides(color = guide_legend(title = "Gender")) +
            theme(panel.grid.minor.x = element_blank(),
                  axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position="bottom",
                  legend.text = element_text(size = 7),
                  legend.title = element_text(size = 8, face = "italic"),
                  legend.margin = margin(0,0,0,0), 
                  plot.title = element_text(size = 8),
                  axis.title = element_text(size = 7),
                  axis.text = element_text(size = 7))
  
ggsave(Age_Gender_Plot_State_Year[[i]], filename = paste0("P. vivax cases stratified by age and gender in ", States_sivep[[i]], " ", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 

  }

```

##Heatmap
###Age and gender cases
### Plotando matrix de intensidade de casos por FE e sexo por estado
- repensar a agregação das faixas etárias e talvez repensar em usar o API.  

#### Agregando o banco para o plot: somando os casos por estado por ano  
```{r}
dAge <- Sivep_strat %>% 
  filter(LEVEL == "UF") %>% 
  group_by(STATE, YEAR, AGE_CAT, GENDER, TYPE) %>%
  mutate(SUMCASES = sum(CASES, na.rm = TRUE))

```

- Plot por estado: ver qual variável fica melhor no eixo x ou y. Gostei mais do jeito que está.
```{r}
#ggplot(aes(x = AGE_CAT, y = YEAR, fill = SUMCASES), data = subset(dAge, TYPE == "Vivax" & STATE == "RO")) + 
ggplot(aes(x = YEAR, y = AGE_CAT, fill = SUMCASES), data = subset(dAge, TYPE == "Vivax" & STATE == "RO")) +   
  geom_raster() + 
  facet_grid(GENDER ~ .) +
#  scale_fill_manual(values = c("#31a354","#3182bd")) +
#  scale_y_continuous(breaks = c(2004:2018)) +
  scale_x_continuous(breaks = c(2004:2018)) +
  scale_y_log10() +
#  scale_fill_gradient(low = "blue", high =  "darkblue") +
  scale_fill_distiller(palette = "Blues") +  # type if a number, pallete if a string. 
  labs(title = paste0("P. vivax cases stratified by age and gender in ", "RO", " ",  
  #            StartYear, "-", EndYear), x = "Age categories", y = "Cases intensity by year") +  
              StartYear, "-", EndYear), x = "Number of cases by year", y = "Age categories") +  
  guides(color = guide_legend(title = "Cases")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```

# Automatizado - atualizar o restante dos gráficos quando for salvar novamente a partir desse modelo
Para conseguir salvar tenho que rodar sem o ggsave primeiro. Depois que salvar, tenho que remover o objeto para conseguir rodar e salvar novamente.
```{r}
States_sivep <- c("AC","AM","AP","MA","MT","PA","RO","RR","TO")
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

# Tipo de malária
typemalaria <- T # T = Vivax, F = Falciparum
if(typemalaria){
  Plot_Folder <- "/home/rlana/Plots/Age_Gender/Matrix/Vixax" 
  tipo <- "Vivax"
  tipomin <- "vivax" 
  cor <- "Blues"
}else{
  Plot_Folder <- "/home/rlana/Plots/Age_Gender/Matrix/Falciparum" 
  tipo <- "Falciparum"
  tipomin <- "falciparum" 
  cor <- "Greens"}


for (uf in States_sivep){
  plt <- ggplot(data = dAge[dAge$LEVEL == "UF" & dAge$STATE == uf & dAge$TYPE == tipo,], 
                aes(x = YEAR, y = AGE_CAT, fill = SUMCASES)) +
    geom_raster() + 
    facet_grid(GENDER ~ .) +
    scale_x_continuous(breaks = c(2004:2018),
                      expand = c(0.01, 0)) +
    scale_fill_distiller(palette = cor) +   
    labs(title = paste0("P."," ", tipomin," ", "cases stratified by age and gender in ", uf, " ",  
                        StartYear, "-", EndYear), x = "Number of cases by year", y = "Age categories") +  
    guides(fill = guide_colourbar(title = "Cases", reverse = T)) + ### Decidir se quer deixar o reverse T ou F- falci está T
    theme(panel.grid.minor.x = element_blank(),   ### Refazer os tamanhos de letra
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position="right",
          legend.text = element_text(size = 7),
          legend.title = element_text(size = 8, face = "italic"),
          legend.margin = margin(0,0,0,0), 
          plot.title = element_text(size = 8),
          axis.title = element_text(size = 7),
          axis.text = element_text(size = 7))
  
ggsave(plt, filename = paste0("P."," ", tipomin," ", "cases stratified by age and gender in ", uf, " ", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 

}

```

### Testando outra agregação para Faixa Etária

- Pensando: primeiro crio uma variavel nova e recategorizo, depois uso summarize?- ver funções para recategorizar variáveis.
- Testes:  
0-9, 10-19, 20-39, 40-49, 50-59, 60+ e de 10 em 10 com 60+

#### Testar os outros plots de age and gender com o banco antigo que tem IPA estratificado- testar isso depois de recategorizar igual aqui.

```{r}
dAgen <- dAge %>%
  mutate(AGE_CAT_N = fct_collapse(AGE_CAT,
                                  '0-9' = c("0-4", "5-9"),
                                  '10-19' = c("10-14", "15-19"),
                                  '20-39' = c("20-24", "25-29", "30-34", "35-39"),
                                  '40-49' = c("40-44", "45-49"),
                                  '50-59' = c("50-54", "55-59"),
                                  '60+' = c("60-64", "65-69", "70-74", "75-79", "80+"))) 

fct_count(dAge$AGE_CAT)

dAgen <- dAgen %>% 
   mutate(AGE_CAT_N10 = fct_collapse(AGE_CAT,
                                  '0-9' = c("0-4", "5-9"),
                                  '10-19' = c("10-14", "15-19"),
                                  '20-29' = c("20-24", "25-29"),
                                  '30-39' = c("30-34", "35-39"),
                                  '40-49' = c("40-44", "45-49"),
                                  '50-59' = c("50-54", "55-59"),
                                  '60+' = c("60-64", "65-69", "70-74", "75-79", "80+")))


Plot_Folder = "/home/rlana/Plots/Age_Gender/Matrix/testes"

for (uf in States_sivep){
  plt <- ggplot(data = dAgen[dAgen$LEVEL == "UF" & dAgen$STATE == uf & dAgen$TYPE == tipo,], 
                aes(x = YEAR, y = AGE_CAT_N10, fill = SUMCASES)) +
    geom_raster() + 
    facet_grid(GENDER ~ .) +
    scale_x_continuous(breaks = c(2004:2018),
                      expand = c(0.01, 0)) +
    scale_fill_distiller(palette = cor) +   
    labs(title = paste0("P."," ", tipomin," ", "cases stratified by age and gender in ", uf, " ",  
                        StartYear, "-", EndYear), x = "Number of cases by year", y = "Age categories") +  
    guides(fill = guide_colourbar(title = "Cases", reverse = T)) + ### Decidir se quer deixar o reverse T ou F- falci está T
    theme(panel.grid.minor.x = element_blank(),   ### Refazer os tamanhos de letra
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position="right",
          legend.text = element_text(size = 7),
          legend.title = element_text(size = 8, face = "italic"),
          legend.margin = margin(0,0,0,0), 
          plot.title = element_text(size = 8),
          axis.title = element_text(size = 7),
          axis.text = element_text(size = 7))
  
ggsave(plt, filename = paste0("TESTE2_P."," ", tipomin," ", "cases stratified by age and gender in ", uf, " ", StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 

}
```


##Heatmap - TOP STATES API
Check all legends title and plot title. Optimize plots by state and muncipality

```{r}
#load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/AnaliseExploratoria/API_Noti_week_state_final.Rdata")
load("/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/AnaliseExploratoria/API_Noti_week_state_final.Rdata")

```

- Ranking states
```{r}
dRank <- d8 %>% 
  filter(LEVEL == "UF") %>% 
  select(STATE, NAME, YEAR, TYPE, CASES, POP_SIZE) %>% 
  group_by(STATE, NAME, YEAR, TYPE, POP_SIZE) %>% 
  mutate(SUMCASES = sum(CASES, na.rm = TRUE)) %>%
  select(-CASES) %>% 
  distinct() %>% 
  mutate(API = SUMCASES/POP_SIZE * 1000) %>% 
  arrange(YEAR, TYPE, API)


dRank <- dRank %>% 
  mutate(ONE = 1) %>% 
  group_by(YEAR, TYPE) %>% 
  mutate(RANK = cumsum(ONE)) %>% 
  mutate(DSRANK = 10 - RANK)
  
```

### Rank plot per State by year

- State
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)
Plot_Folder = "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV"

rankAPI <- ggplot(aes(x = YEAR, y = RANK, group = STATE, color = STATE), data = subset(dRank, TYPE == "Vivax")) +   
            geom_line(size = 2) + 
            scale_x_continuous(breaks = c(2004:2018)) +
            labs(title = paste0("P. vivax API ranked by state", " ",  
                        StartYear, "-", EndYear), x = "Year", y = "API Rank") +  
            guides(color = guide_legend(title = "States")) +
            theme(panel.grid.minor.x = element_blank(),
                  axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position="right",
                  legend.text = element_text(size = 10),
                  legend.title = element_text(size = 11, face = "italic"),
                  legend.margin = margin(0,0,0,0), 
                  plot.title = element_text(size = 11),
                  axis.title = element_text(size = 10),
                  axis.text = element_text(size = 10))

ggsave(rankAPI, filename = paste0("APIrankedStates", ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 

```


### API "intensity" per State by Year
- Fazer agregado por mês, mas plotar o eixo y com label de ano mesmo, no gráfico de série temporal temos isso. - depois
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)
Plot_Folder = "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV"
dRank$STATE <- factor(dRank$STATE, levels=c("AC", "AM", "RR", "RO", "AP", "PA", "MT", "MA", "TO"))

intAPI <- ggplot(aes(x = YEAR, y = STATE, fill = API), data = subset(dRank, TYPE == "Vivax")) +   
          geom_raster() + 
          scale_x_continuous(breaks = c(2004:2018)) +
          scale_fill_distiller(palette = "RdYlGn") +  # type if a number, pallete if a string. #"RdYlGn"
          labs(title = paste0("P. vivax API ranked by state", " ",  
                      StartYear, "-", EndYear), x = "Year", y = "States") +  
          guides(color = guide_legend(title = "API")) +
          theme(panel.grid.minor.x = element_blank(),
                axis.text.x = element_text(angle = 90, hjust = 1),
                legend.position="right",
                legend.text = element_text(size = 10),
                legend.title = element_text(size = 11, face = "italic"),
                legend.margin = margin(0,0,0,0), 
                plot.title = element_text(size = 11),
                axis.title = element_text(size = 10),
                axis.text = element_text(size = 10))

ggsave(intAPI, filename = paste0("APIintStates", ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 

```



### Cases contribution per year by state 

#Daniel, ainda não consegui descobrir como salvar esse tipo de figura. Por enquanto salvei o html.

```{r}
# Falciparum
dRank %>% 
  filter(TYPE == "Falciparum") %>% 
  streamgraph(key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand") %>% 
  sg_axis_x(1, "YEAR", "%Y") 

#webshot(teste, "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV/output.png", delay = 0.2 , cliprect = c(440, 0, 1000, 10))

  
# Vivax
dRank %>% 
  filter(TYPE == "Vivax") %>% 
  streamgraph(key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand") %>% 
  sg_axis_x(1, "YEAR", "%Y") 


```

- ver ajuda, blog etc paraa ajusta a escala do eixo x e como salvar. https://hrbrmstr.github.io/streamgraph/


#### Ranking municipalities group by state

```{r}
dRankms <- d8 %>% 
  filter(LEVEL == "MU") %>% 
  select(CODE, STATE, NAME, YEAR, TYPE, CASES, POP_SIZE) %>% 
  group_by(CODE, STATE, YEAR, TYPE, POP_SIZE) %>% 
  mutate(SUMCASES = sum(CASES, na.rm = TRUE)) %>%
  select(-CASES) %>% 
  distinct() %>% 
  mutate(API = SUMCASES/POP_SIZE * 1000) %>% 
  arrange(YEAR, TYPE, API)


dRankms <- dRankms %>% 
  mutate(ONE = 1) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  mutate(RANK = cumsum(ONE)) 
  
```

- All municipalities colored by estado
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

ggplot(aes(x = YEAR, y = RANK, group = NAME, color = NAME), data = subset(dRankms, TYPE == "Vivax" & STATE == "AM")) +   
  geom_line(size = 2) + 
  scale_x_continuous(breaks = c(2004:2018)) +
  labs(title = paste0("P. vivax API ranked by state", " ",  
              StartYear, "-", EndYear), x = "Year", y = "Rank") +  
  guides(color = guide_legend(title = "Municipalities")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```


#### Automatizado, mas sem legenda
```{r}
States_sivep <- c("AC","AM","AP","MA","MT","PA","RO","RR","TO")
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

# Tipo de malária
typemalaria <- F # T = Vivax, F = Falciparum
if(typemalaria){
  Plot_Folder <- "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV/Vivax" 
  tipo <- "Vivax"
  tipomin <- "vivax" 
#  cor <- "Blues"
}else{
  Plot_Folder <- "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV/Falciparum" 
  tipo <- "Falciparum"
  tipomin <- "falciparum" 
#  cor <- "Greens"
  }

# retirar a legenda
for (uf in States_sivep){
 rankMuni <- ggplot(aes(x = YEAR, y = RANK, group = NAME, color = NAME), data = dRankms[dRankms$STATE == uf & dRankms$TYPE == tipo,]) +   
  geom_line(size = 2) + 
  scale_x_continuous(breaks = c(2004:2018)) +
  labs(title = paste0("P. ", tipomin," ", "API ranked by municipality in ", uf, " ",  
                        StartYear, "-", EndYear), x = "Year", y = "Rank") +  
#  guides(color = guide_legend(title = "Municipalities")) +
  theme(panel.grid.minor.x = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))
 
ggsave(rankMuni, filename = paste0("P.",tipomin,"API_muni", uf, StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 
  
}

```

- grid by municipality - para muitos municípios fica ruim.
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

ggplot(aes(x = YEAR, y = RANK, group = NAME, color = NAME), data = subset(dRankms, TYPE == "Vivax" & STATE == "AM")) +   
  geom_line(size = 2) + 
  facet_wrap(NAME ~ ., ncol = 3) +
  scale_x_continuous(breaks = c(2004:2018)) +
  labs(title = paste0("P. vivax API ranked by state", " ",  
              StartYear, "-", EndYear), x = "Year", y = "Rank") +  
  guides(color = guide_legend(title = "Municipalities")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```

- Matrix
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

ggplot(aes(x = YEAR, y = NAME, fill = API), data = subset(dRankms, TYPE == "Vivax" & STATE == "AM")) + 
  geom_raster() + 
  scale_x_continuous(breaks = c(2004:2018)) +
  scale_fill_distiller(palette = "RdYlGn") +  # type if a number, pallete if a string. #"RdYlGn"
  labs(title = paste0("P. vivax API by state", " ",  
              StartYear, "-", EndYear), x = "Year", y = "States") +  
  guides(color = guide_legend(title = "API")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```

#### Matriz automatizada
```{r}
States_sivep <- c("AC","AM","AP","MA","MT","PA","RO","RR","TO")
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

# Tipo de malária
typemalaria <- F # T = Vivax, F = Falciparum
if(typemalaria){
  Plot_Folder <- "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV/Vivax" 
  tipo <- "Vivax"
  tipomin <- "vivax" 
#  cor <- "Blues"
}else{
  Plot_Folder <- "/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Plost_RML_DV/Falciparum" 
  tipo <- "Falciparum"
  tipomin <- "falciparum" 
#  cor <- "Greens"
  }

# retirar a legenda
for (uf in States_sivep){
 intMuni <- ggplot(aes(x = YEAR, y = NAME, fill = API), data = dRankms[dRankms$STATE == uf & dRankms$TYPE == tipo,]) +   
  geom_raster() + 
  scale_x_continuous(breaks = c(2004:2018)) +
  scale_fill_distiller(palette = "RdYlGn") + 
  labs(title = paste0("P. ", tipomin," ", "API by municipality in ", uf, " ",  
                        StartYear, "-", EndYear), x = "Year", y = "States") +  
  guides(color = guide_legend(title = "API")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text.y = element_text(size = 4))
 
ggsave(intMuni, filename = paste0("P.",tipomin,"API_muni_intensity", uf, StartYear, "-", EndYear, ".png"), width = 2500/300, height = 2000/300, dpi = 300, path = Plot_Folder, units = "in", device = "png") 
  
}

```


```{r}
# base
# Falciparum
streamgraph(dRankms[dRankms$TYPE == "Falciparum" & dRankms$STATE == "AM",], key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand")
# Vivax
streamgraph(dRankms[dRankms$TYPE == "Vivax" & dRankms$STATE == "AM",], key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand")

# Tidyverse - ver se consigo automatizar
# Falciparum
dRankms %>% 
  filter(TYPE == "Falciparum" & STATE == "TO") %>% 
  streamgraph(key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand") %>% 
  sg_axis_x(1, "YEAR", "%Y") %>% 
  sg_legend(show = TRUE, label = "Municipalities: ")

  
# Vivax
dRankms %>% 
  filter(TYPE == "Vivax" & STATE == "TO") %>% 
  streamgraph(key = "NAME", value = "SUMCASES", date = "YEAR", offset = "expand") %>% 
  sg_axis_x(1, "YEAR", "%Y") %>% 
  sg_legend(show=TRUE, label="Municipalities: ")

  
```


### Rank by municipality

- Ranking municipalities *without* group by state
```{r}
dRankm <- d8 %>% 
  filter(LEVEL == "MU") %>% 
  select(CODE, STATE, NAME, YEAR, TYPE, CASES, POP_SIZE) %>% 
  group_by(CODE, STATE, YEAR, TYPE, POP_SIZE) %>% 
  mutate(SUMCASES = sum(CASES, na.rm = TRUE)) %>%
  select(-CASES) %>% 
  distinct() %>% 
  mutate(API = SUMCASES/POP_SIZE * 1000) %>% 
  arrange(YEAR, TYPE, API)


dRankm <- dRankm %>% 
  mutate(ONE = 1) %>% 
  group_by(YEAR, TYPE) %>% 
  mutate(RANK = cumsum(ONE)) 
  
```

- All municipalities colored by estado
```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

ggplot(aes(x = YEAR, y = RANK, group = CODE, color = STATE), data = subset(dRankm, TYPE == "Vivax")) +   
  geom_line(size = 2) + 
  scale_x_continuous(breaks = c(2004:2018)) +
  labs(title = paste0("P. vivax API ranked by state", " ",  
              StartYear, "-", EndYear), x = "Year", y = "Rank") +  
  guides(color = guide_legend(title = "States")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```


```{r}
StartYear <- 2004 # (inferior limit = 2004)
EndYear <- 2018 # (superior limit = 2018)

ggplot(aes(x = YEAR, y = NAME, fill = API), data = subset(dRankm, TYPE == "Vivax")) + 
  geom_raster() + 
  scale_x_continuous(breaks = c(2004:2018)) +
  scale_fill_distiller(palette = "RdYlGn") +  # type if a number, pallete if a string. #"RdYlGn"
  labs(title = paste0("P. vivax API ranked by state", " ",  
              StartYear, "-", EndYear), x = "Year", y = "States") +  
  guides(color = guide_legend(title = "API")) +
  theme(panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position="right",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8, face = "italic"),
        legend.margin = margin(0,0,0,0), 
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 7))

```





